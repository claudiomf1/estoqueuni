# docker-compose.base.yml
# Configuração base do EstoqueUni (comum a dev e prod)
# Use com: docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up

services:
  # Backend Principal
  estoqueuni-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: estoqueuni-backend
    expose:
      - "3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - ESTOQUEUNI_PORT=3000
      # MongoDB
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_URI_LOCAL=${MONGODB_URI_LOCAL}
      - MONGODB_URI_REMOTE=${MONGODB_URI_REMOTE}
      - ESTOQUEUNI_DB_TIPO=${ESTOQUEUNI_DB_TIPO:-2}
      # JWT
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-24h}
      # CORS (será sobrescrito nos overrides se necessário)
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost}
      # Redis (para BullMQ)
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}
    depends_on:
      - redis
    networks:
      - estoqueuni-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  # Backend AI (Chat Inteligente)
  estoqueuni-backend-ai:
    build:
      context: ./backend-ai
      dockerfile: Dockerfile
    container_name: estoqueuni-backend-ai
    expose:
      - "3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - ESTOQUEUNI_AI_PORT=3000
      - ESTOQUEUNI_AI_HOST=0.0.0.0
      - API_PREFIX=${API_PREFIX:-/api/v1}
      # MongoDB
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_URI_LOCAL=${MONGODB_URI_LOCAL}
      - MONGODB_URI_REMOTE=${MONGODB_URI_REMOTE}
      - ESTOQUEUNI_DB_TIPO=${ESTOQUEUNI_DB_TIPO:-2}
      # Redis
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      # Qdrant
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      - QDRANT_COLLECTION_NAME=${QDRANT_COLLECTION_NAME:-estoqueuni_docs}
      # Skip externals (usa mock em memória para Qdrant se não disponível)
      - ESTOQUEUNI_SKIP_EXTERNALS=${ESTOQUEUNI_SKIP_EXTERNALS:-true}
      # Gemini
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-1.5-flash}
      - ESTOQUEUNI_GEMINI_EMBEDDING_MODEL=${ESTOQUEUNI_GEMINI_EMBEDDING_MODEL:-embedding-001}
      # JWT
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      # CORS
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost}
    networks:
      - estoqueuni-net
    restart: unless-stopped
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  # Frontend
  estoqueuni-frontend:
    build:
      context: .
      dockerfile: ./frontend/Dockerfile
    container_name: estoqueuni-frontend
    expose:
      - "80"
    networks:
      - estoqueuni-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Nginx Proxy Reverso
  nginx-proxy:
    image: nginx:alpine
    container_name: estoqueuni-nginx
    # Portas NÃO expostas - nginx do sistema gerencia 80/443
    # ports:
    #   - "80:80"
    #   - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # Diretório vazio para suprimir scripts padrão do entrypoint (evita logs/avisos desnecessários)
      - ./nginx/entrypoint-empty:/docker-entrypoint.d:ro
      # Webroot para Let's Encrypt
      - /var/www/certbot:/var/www/certbot:ro
    environment:
      # Evita que o script 10-listen-on-ipv6-by-default.sh tente alterar o default.conf (read-only)
      - ENABLE_IPV6=false
      - DISABLE_IPV6=true
    networks:
      - estoqueuni-net
    restart: unless-stopped
    depends_on:
      - estoqueuni-backend
      - estoqueuni-backend-ai
      - estoqueuni-frontend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  # Redis (para BullMQ e cache)
  redis:
    image: redis:7-alpine
    container_name: estoqueuni-redis
    expose:
      - "6379"
    volumes:
      - redis-data:/data
    networks:
      - estoqueuni-net
    restart: unless-stopped
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

networks:
  estoqueuni-net:
    driver: bridge

volumes:
  redis-data:
    driver: local
